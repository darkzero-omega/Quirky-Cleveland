<!DOCTYPE html>
<html>
<head>
	<title>Google Maps Firebase</title>
	<style>
      #map {
        width: 100%;
        height: 400px;
        background-color: grey;
      }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/4.11.0/firebase.js"></script>
</head>
<body>
	<h3>My Google Maps with Firebase</h3>
    <button id="togglepreloaded">Show/Hide PreLoaded</button><button id="toggleuseradded">Show/Hide User Added</button>
    <div id="map"></div>
    <h3>Add a new attraction</h3>
      <input type="text" name="" id="geocodinginput"><button id="geocoding">Search for Address</button>
    <div id="geocoding-response"></div>
    <hr>
    <h3>Search the map</h3>
      <input id="autocomplete">
      <button id="search">Search</button>
    <button id="togglesearchresults">Clear Search Results</button>
    <br>
    <input type="text" id="searchResultsInput" placeholder="Start typing here to search results">
    <table>
      <tr>
        <th>Name </th>
        <th>Address </th>
        <th>Additional Information</th>
      </tr>
      <tbody id="places"></tbody>
    </table>
    <hr>
    <h2>Browse Attractions</h2>
      <h3>Our own recommended offbeat attractions:</h3>
      <input type="text" id="searchpreloaded" placeholder="Start typing to search attractions">
        <table>
        <tr>
          <th>Name </th>
          <th>Address </th>
          <th>Additional Information</th>
        </tr>
        <tbody id="preloaded-list"></tbody>
      </table>
      <hr>
      <h3>User Recommended offbeat attractions:</h3>
      <input type="text" id="search-user-added" placeholder="Start typing to search attractions">
        <table>
          <tr>
            <th>Name </th>
            <th>Address </th>
            <th>Additional Information</th>
          </tr>
          <tbody id="user-added-list"></tbody>
        </table>
  <script>
    //$(document).ready(function() {
      $("#searchResultsInput").on("keyup", function() {
        var value = $(this).val().toLowerCase();
        $("#places tr").filter(function() {
          $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
      });
    //});

    //$(document).ready(function() {
      $("#searchpreloaded").on("keyup", function() {
        var value = $(this).val().toLowerCase();
        $("#preloaded-list tr").filter(function() {
          $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
      });
    //});

    //$(document).ready(function() {
      $("#search-user-added").on("keyup", function() {
        var value = $(this).val().toLowerCase();
        $("#user-added-list tr").filter(function() {
          $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
      });
    //});

    var config = {
      apiKey: "AIzaSyBNvq6AmEOQst9c2aSTD6sFlQ0MmHmX2j0",
      authDomain: "new-project-97d65.firebaseapp.com",
      databaseURL: "https://new-project-97d65.firebaseio.com",
      projectId: "new-project-97d65",
      storageBucket: "new-project-97d65.appspot.com",
      messagingSenderId: "151445565306"
    };

    firebase.initializeApp(config);

    var database = firebase.database();
    
    var preLoadedAttractions = [];

    var map;
    var searchEntry;

    var showPreLoaded;
    var preLoadedMarkers = [];

    var showSearchResults;
    var searchMarkers = [];

    //var newAttractions = [];
    var newAttractionsMarkers = [];
    var showUserAdded;

    var geocodingAddress;
    var geocodingPosition;
    var geocodingName;

    function initMap() {
      database.ref("preloaded/preloaded-attractions").once('value').then(function(snapshot) {

        preLoadedAttractions = snapshot.val();
        
        var options = {
          zoom: 11,
          center: {lat: 41.4993, lng: -81.6944 }
        }

        map = new google.maps.Map(document.getElementById("map"), options)

        var bounds = new google.maps.LatLngBounds(
          {lat: 41.359552, lng: -81.965657}, {lat: 41.615186, lng: -81.398746});
        map.fitBounds(bounds);


      //This Code deals with setting, showing, and hiding preloaded data
        function setPreLoadedAttractions() {
          showPreLoaded = true;

          for (i = 0; i < preLoadedAttractions.length; i++) {
            var marker = new google.maps.Marker({
              position: preLoadedAttractions[i].position,
              map: map,
              icon: "https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png"});

            marker.content = "<strong>" + preLoadedAttractions[i].name + "</strong>" + "<br> " + preLoadedAttractions[i].address;

            var infoWindow = new google.maps.InfoWindow();
            google.maps.event.addListener(marker, "click", function() {
              infoWindow.setContent(this.content);
              infoWindow.open(this.getMap(), this);
            });

            preLoadedMarkers.push(marker);
          }     
        }

        setPreLoadedAttractions();

        togglepreloaded.onclick = function(event) {
          if (showPreLoaded === true) {
            removePreLoadedMarkers();
            showPreLoaded = false;
            return;
          } if (showPreLoaded === false) {
            setPreLoadedAttractions();
            showPreLoaded = true;
            return;
          }
          
        }
        
        function removePreLoadedMarkers() {
          for (i = 0; i < preLoadedMarkers.length; i++) {
            preLoadedMarkers[i].setMap(null);
          }
          preLoadedMarkers = [];
        }

      });
      //This code deals with searching the map using the places and autocomplete api
      search.onclick = function(event) {
        removeSearchResults();
        searchEntry = document.getElementById("autocomplete").value
        document.getElementById("autocomplete").value = "";
        //document.getElementById("searchResultsInput").value = "";
        
        var bounds = new google.maps.LatLngBounds(
          {lat: 41.359552, lng: -81.965657}, {lat: 41.615186, lng: -81.398746});
        map.fitBounds(bounds);

        var request = {
          bounds: bounds,
          query: searchEntry
        }

        var service = new google.maps.places.PlacesService(map);
        service.textSearch(request, callback);

        function callback(results, status) {
          if (status == google.maps.places.PlacesServiceStatus.OK) {
            for (var i = 0; i < results.length; i++) {
              var place = results[i];
              createList(results[i]);
              var marker = new google.maps.Marker({
                position: place.geometry.location,
                map: map,
              })

              marker.content = "<strong>" + place.name + "</strong>" + "<br> " + place.formatted_address;

              var infoWindow = new google.maps.InfoWindow();
              google.maps.event.addListener(marker, "click", function() {
                infoWindow.setContent(this.content);
                infoWindow.open(this.getMap(), this);
              });

              searchMarkers.push(marker);
            }
          }
        }

        function createList(place) {
          var placesList = document.getElementById("places")

          var newRow = document.createElement('tr');
          placesList.appendChild(newRow);

          var nameTD = document.createElement('td');
          newRow.appendChild(nameTD);
          nameTD.textContent = place.name;

          var addressTD = document.createElement('td');
          newRow.appendChild(addressTD);
          addressTD.textContent = place.formatted_address;

          var infoTD = document.createElement('td');
          newRow.appendChild(infoTD);
          infoTD.textContent = "Sample Text Here";
          }
      }

      togglesearchresults.onclick = function(event) {
        removeSearchResults();
      }

      function removeSearchResults() {
        for (i = 0; i < searchMarkers.length; i++) {
          searchMarkers[i].setMap(null);
        }
        searchMarkers = [];
        var placesList = document.getElementById("places")
        placesList.innerHTML = "";
        document.getElementById("searchResultsInput").value = "";
      }

      $(document).on("click", "#submit", function() {
        geocodingName = document.getElementById("locationname").value;

        database.ref("/user added attractions").push({
          position: geocodingPosition, 
          name: geocodingName, 
          address: geocodingAddress
        })

        setAddedAttractions();
      });

      $(document).on("click", "#clearaddress", function() {
        document.getElementById("geocoding-response").innerHTML = "";
        document.getElementById("geocodinginput").value = "";
      })

      function setAddedAttractions() {
        showUserAdded = true;

        database.ref("/user added attractions").once('value').then(function(snapshot) {
        snapshot.forEach(function(place) { 

          var marker = new google.maps.Marker({
            position: place.val().position,
            map: map,
          })

          marker.content = "<strong>" + place.val().name + "</strong>" + "<br> " + place.val().address;

          var infoWindow = new google.maps.InfoWindow();
            google.maps.event.addListener(marker, "click", function() {
               infoWindow.setContent(this.content);
               infoWindow.open(this.getMap(), this);
            });

          newAttractionsMarkers.push(marker);
         })
      });
    }

    setAddedAttractions();

    function removeNewAttractionsMarkers() {
          for (i = 0; i < newAttractionsMarkers.length; i++) {
            newAttractionsMarkers[i].setMap(null);
          }
          newAttractionsMarkers = [];
        }

    toggleuseradded.onclick = function(event) {
      if (showUserAdded === true) {
        removeNewAttractionsMarkers();
        showUserAdded = false;
      } else if (showUserAdded === false) {
        setAddedAttractions();
      }
      
    }

    //code for setting a new attraction added by user
      geocoding.onclick = function(event) {
        var address = document.getElementById("geocodinginput").value;
        if (document.getElementById("geocoding-response").innerHTML === "") {
          $.ajax({
            url: "https://maps.googleapis.com/maps/api/geocode/json?address=" + address + "&key=AIzaSyB00HoG_XIHLQirqHUmhGSR1aBdnDjjCms",
            method: "GET"
          }).then(function(response) {
            var geocodingResponse = document.getElementById("geocoding-response");
            var addressDiv = document.createElement('div');
            geocodingResponse.appendChild(addressDiv);

            addressDiv.innerHTML = "<p>Is this the address you were looking for?</p>" +
                                   "<p><strong>" + response.results[0].formatted_address + "</strong></p>" + "<p>If yes, enter the name of the location and click submit to add it to the map.</p><input id='locationname'><button id='submit'>Submit</button><button id='clearaddress'>Clear result</button>"
            
            geocodingAddress = response.results[0].formatted_address;
            geocodingPosition = response.results[0].geometry.location;
          });
        } 
      }

      database.ref("/user added attractions").on("child_added", function(snapshot) {
        createUserAddedList();
        setAddedAttractions();
      });
    }

    function createPreloadedList() {
      database.ref("/preloaded/preloaded-attractions").once('value').then(function(snapshot) {

        for (i = 0; i < snapshot.val().length; i++) {
          var name = snapshot.val()[i].name;
          var address = snapshot.val()[i].address;
          var info = "sample text here";

          var preloadedList = document.getElementById("preloaded-list");
          var newRow = document.createElement('tr');
          preloadedList.appendChild(newRow);

          var nameTD = document.createElement('td');
          newRow.appendChild(nameTD);
          nameTD.textContent = name;

          var addressTD = document.createElement('td');
          newRow.appendChild(addressTD);
          addressTD.textContent = address;

          var infoTD = document.createElement('td');
          newRow.appendChild(infoTD);
          infoTD.textContent = info;
        }
      })
    }

    createPreloadedList();

    function createUserAddedList() {
      
      database.ref("/user added attractions").once('value').then(function(snapshot) {
        document.getElementById("user-added-list").innerHTML = "";

        snapshot.forEach(function(place) {

          var name = place.val().name;
          var address = place.val().address;
          var info = "sample text here";

          var userAddedList = document.getElementById("user-added-list");
          var newRow = document.createElement('tr');
          userAddedList.appendChild(newRow);

          var nameTD = document.createElement('td');
          newRow.appendChild(nameTD);
          nameTD.textContent = name;

          var addressTD = document.createElement('td');
          newRow.appendChild(addressTD);
          addressTD.textContent = address;

          var infoTD = document.createElement('td');
          newRow.appendChild(infoTD);
          infoTD.textContent = info;
        });
      })
    }

  // database.ref("/user added attractions").on("child_added", function(snapshot) {
  //   createUserAddedList();
  //   setAddedAttractions();
  // });

  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB00HoG_XIHLQirqHUmhGSR1aBdnDjjCms&callback=initMap&libraries=places,geometry">
  </script>
</body>
</html>  